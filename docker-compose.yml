services:
  rauskuclaw-api:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: rauskuclaw-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - RAUSKUCLAW_CONFIG_PATH=${RAUSKUCLAW_CONFIG_PATH:-/config/rauskuclaw.json}
      - DB_PATH=${DB_PATH:-/data/rauskuclaw.sqlite}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://rauskuclaw-ollama:11434}
      - DEPLOY_TARGET_ALLOWLIST=${DEPLOY_TARGET_ALLOWLIST:-staging}
      - CALLBACK_ALLOWLIST=${CALLBACK_ALLOWLIST:-}
      - ALLOW_DEV_ENDPOINTS=${ALLOW_DEV_ENDPOINTS:-1}
    depends_on:
      - rauskuclaw-ollama
    volumes:
      - ./data:/data
      - ./workspace:/workspace
      - ./rauskuclaw.json:/config/rauskuclaw.json:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - holvi_bridge
    ports:
      # API only on localhost (host Nginx exposes it)
      - "127.0.0.1:3001:3001"
    command: ["node", "server.js"]

  rauskuclaw-worker:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: rauskuclaw-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - RAUSKUCLAW_CONFIG_PATH=${RAUSKUCLAW_CONFIG_PATH:-/config/rauskuclaw.json}
      - DB_PATH=${DB_PATH:-/data/rauskuclaw.sqlite}
      - WORKER_POLL_MS=${WORKER_POLL_MS:-300}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://rauskuclaw-ollama:11434}
      - DEPLOY_TARGET_ALLOWLIST=${DEPLOY_TARGET_ALLOWLIST:-staging}
      - CALLBACK_ALLOWLIST=${CALLBACK_ALLOWLIST:-}
    depends_on:
      - rauskuclaw-ollama
    volumes:
      - ./data:/data
      - ./workspace:/workspace
      - ./rauskuclaw.json:/config/rauskuclaw.json:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - holvi_bridge
    command: ["node", "worker-only.js"]

  rauskuclaw-ollama:
    image: ollama/ollama:latest
    container_name: rauskuclaw-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama

  rauskuclaw-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: rauskuclaw-ui
    restart: unless-stopped
    ports:
      # UI on localhost, host Nginx maps /ui/ to this
      - "127.0.0.1:3002:8080"

  rauskuclaw-ui-v2:
    build:
      context: ./ui-v2
      dockerfile: Dockerfile
    container_name: rauskuclaw-ui-v2
    restart: unless-stopped
    ports:
      # UI-v2 on localhost port 3003
      - "127.0.0.1:3003:8080"

volumes:
  ollama_data:

networks:
  holvi_bridge:
    external: true
    name: holvi_holvi_net
